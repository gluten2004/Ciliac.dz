<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø³Ø­ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to right, #ffecd2, #4ddbed);
            text-align: center;
            padding: 20px;
            color: #333;
        }
        header {
            background-color: #4ad059;
            color: white;
            padding: 15px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #scanner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: auto;
        }
        #reader {
            width: 100%;
            margin-bottom: 15px;
        }
        .result {
            font-size: 20px;
            font-weight: bold;
            color: #5fa0c5;
            margin-top: 10px;
            padding: 10px;
            background: #dde1e2;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .back-btn {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 18px;
            background: #23ce4b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }
        .back-btn:hover {
            background: #60bdff;
        }
    </style>
</head>
<body>
    <header>Ù…Ø§Ø³Ø­ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</header>
    <div id="scanner-container">
        <div id="reader"></div>
        <p class="result" id="result">Ù‚Ù… Ø¨Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù†ØªÙŠØ¬Ø©</p>
        <button class="back-btn" onclick="window.history.back()">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>

    <script>
        async function fetchProductData(barcode) {
            try {
                let apiUrl = `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`;
                let response = await fetch(apiUrl);
                let data = await response.json();

                console.log("ğŸ“¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©:", data);

                if (!data || !data.product) {
                    document.getElementById('result').innerText = "âš ï¸ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!";
                    return;
                }

                let product = data.product;
                let productName = product.product_name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                let brand = product.brands || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

                let ingredients = (
                    product.ingredients_text_ar || 
                    product.ingredients_text_fr || 
                    product.ingredients_text_en || 
                    product.ingredients_text || 
                    ""
                ).toLowerCase().trim();

                console.log("ğŸ½ï¸ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:", ingredients);

                let gluten_status = "ğŸš¨ ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

                if (product.ingredients_analysis_tags && Array.isArray(product.ingredients_analysis_tags)) {
                    if (product.ingredients_analysis_tags.includes("en:gluten-free")) {
                        gluten_status = "âœ… Ø®Ø§Ù„Ù Ù…Ù† Ø§Ù„ØºÙ„ÙˆØªÙŠÙ†";
                    } else if (product.ingredients_analysis_tags.includes("en:contains-gluten")) {
                        gluten_status = "âŒ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØºÙ„ÙˆØªÙŠÙ†";
                    }
                }

                if (gluten_status === "ğŸš¨ ØºÙŠØ± Ù…Ø­Ø¯Ø¯" && ingredients) {
                    let glutenKeywords = [
                        "Ù‚Ù…Ø­", "ÙØ±ÙŠÙ†Ø©", "ÙØ±ÙŠÙ†Ø© Ø§Ù„Ù‚Ù…Ø­", "Ø¬Ù„ÙˆØªÙŠÙ†", "Ø´Ø¹ÙŠØ±", "ÙƒØ³ÙƒØ³", "Ø´ÙˆÙØ§Ù†", "Ù†Ø´Ø§ Ø§Ù„Ù‚Ù…Ø­", "Ø³Ù…ÙŠØ¯ Ø§Ù„Ù‚Ù…Ø­", 
                        "wheat", "flour", "gluten", "barley", "couscous", "oats", "wheat starch", "semolina",
                        "blÃ©", "farine", "gluten", "orge", "couscous", "avoine", "amidon de blÃ©", "semoule de blÃ©"
                    ];

                    let containsGluten = glutenKeywords.some(word => ingredients.includes(word));

                    if (containsGluten) {
                        gluten_status = "âŒ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØºÙ„ÙˆØªÙŠÙ† (ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª)";
                    } else {
                        gluten_status = "âœ… Ø®Ø§Ù„Ù Ù…Ù† Ø§Ù„ØºÙ„ÙˆØªÙŠÙ† (ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª)";
                    }
                }

                document.getElementById('result').innerHTML = `
                    ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: ${productName} <br>
                    ğŸ­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©: ${brand} <br>
                    ğŸ½ï¸ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª: ${ingredients || "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒÙˆÙ†Ø§Øª"} <br>
                    âš ï¸ Ø­Ø§Ù„Ø© Ø§Ù„ØºÙ„ÙˆØªÙŠÙ†: ${gluten_status}
                `;
            } catch (error) {
                document.getElementById('result').innerText = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!";
                console.error("âŒ Ø®Ø·Ø£:", error);
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById('result').innerText = "Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
            fetchProductData(decodedText);
        }

        function onScanFailure(error) {
            console.warn(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­: ${error}`);
        }

        let html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    </script>
</body>
</html>
